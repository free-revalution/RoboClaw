# RoboPartner 项目开发文档

## 一、Agent 可实现的功能

### 1.1 核心交互工具

RoboPartner 是一个 AI Agent 框架，通过七大核心工具实现与开发环境和物理世界的交互：

| 工具名称 | 功能描述 | 应用场景 |
|---------|---------|---------|
| Read | 读取文件内容，支持大文件分页读取 | 阅读代码、配置文件、文档 |
| Write | 创建新文件或覆盖现有文件 | 生成代码、写入配置 |
| Edit | 精确字符串替换，修改文件内容 | 修复 bug、重构代码 |
| Bash | 执行 shell 命令 | 编译、运行测试、系统管理 |
| Serial | 串口通信，发送和接收数据 | 嵌入式设备调试 |
| Browser | 浏览器自动化控制 | 网页测试、自动化操作 |
| Agent | 发现和管理本地 AI 助手 | 多 Agent 协作 |
| Hardware | 硬件控制（新增） | 机器人运动控制、传感器读取 |

### 1.2 浏览器自动化能力

Agent 可以像人类操作浏览器一样执行以下操作：

- 打开和关闭浏览器
- 导航到指定网页
- 截取网页截图
- 点击页面元素（支持 CSS 选择器）
- 在输入框中输入文本
- 执行 JavaScript 代码
- 滚动页面

支持平台：macOS (Safari/Chrome/Firefox)、Linux、Windows

### 1.3 嵌入式机器人控制能力（v0.3.0 新增）

Agent 可以控制连接到计算机的机器人硬件：

- 运动控制：前进、后退、转向、停止
- 传感器读取：IMU（加速度计/陀螺仪）、LiDAR、超声波等
- 硬件配置管理：JSON 格式的硬件描述文件
- 串口通信：支持 RoboClaw、Sabertooth 等电机驱动器

### 1.4 会话管理能力

- 树状对话结构：支持创建分支进行实验，不影响主对话
- 多会话管理：在不同对话之间切换
- 会话持久化：对话历史保存到本地文件

### 1.5 技能系统

Agent 可以加载和执行自定义技能（JSON 格式定义）：
- 技能解析和加载
- 技能注册表管理
- 技能执行引擎
- 技能在线下载

### 1.6 性能优化特性

- 线程池：并发执行任务
- 读写锁：高效的会话历史并发访问
- Token 优化：减少 API 调用成本
- LRU 缓存：Token 估算缓存

---

## 二、项目架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户接口层                              │
│                    (CLI / 交互式模式)                          │
├─────────────────────────────────────────────────────────────────┤
│                         Agent 层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │   Agent      │  │   Prompt     │  │    Tool      │       │
│  │   引擎       │  │   Builder    │  │   Executor   │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
├─────────────────────────────────────────────────────────────────┤
│                         工具层                                │
│  Read  Write  Edit  Bash  Serial  Browser  Agent  Hardware   │
├─────────────────────────────────────────────────────────────────┤
│                      HAL 层（硬件抽象）                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │    Motor     │  │   Sensor     │  │    Comm      │       │
│  │  Controller  │  │  Interface   │  │  Interface   │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
│  ┌──────────────────────────────────────────────────────┐    │
│  │     串口驱动、异常处理、配置管理、机器人技能         │    │
│  └──────────────────────────────────────────────────────┘    │
├─────────────────────────────────────────────────────────────────┤
│                      LLM 层（大模型）                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │  Anthropic   │  │   OpenAI     │  │    HTTP      │       │
│  │  Provider    │  │  Provider    │  │   Client     │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
├─────────────────────────────────────────────────────────────────┤
│                      基础设施层                              │
│  线程池、会话管理、配置管理、日志系统、终端 UI              │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 核心模块说明

#### Agent 层（src/agent/）

| 模块 | 文件 | 主要功能 |
|------|------|---------|
| Agent 引擎 | agent.h/cpp | Agent 主循环，协调对话和工具执行 |
| 工具执行器 | tool_executor.h/cpp | 注册和执行工具，处理工具调用结果 |
| 提示词构建器 | prompt_builder.h/cpp | 构建发送给 LLM 的系统提示词 |

#### 工具层（src/tools/）

| 工具 | 文件 | 主要功能 |
|------|------|---------|
| Read | read_tool.h/cpp | 读取文件，处理路径、分页 |
| Write | write_tool.h/cpp | 写入文件，处理目录创建 |
| Edit | edit_tool.h/cpp | 字符串替换，支持多文件编辑 |
| Bash | bash_tool.h/cpp | 命令执行，捕获输出和错误码 |
| Serial | serial_tool.h/cpp | 串口通信，跨平台封装 |
| Browser | browser_tool.h/cpp | 浏览器自动化，CDP 协议 |
| Agent | agent_tool.h/cpp | Agent 发现，进程检测 |

#### HAL 层（src/hal/）

| 模块 | 文件 | 主要功能 |
|------|------|---------|
| 电机控制接口 | motor_controller.h | 速度、方向控制，紧急停止 |
| 传感器接口 | sensor.h | 数据读取，可用性检查 |
| 通信接口 | comm.h | 串口、I2C、SPI、CAN 抽象 |
| 串口驱动 | drivers/serial_comm.h/cpp | termios 实现，波特率配置 |
| 异常处理 | hal_exception.h | 硬件异常类层次结构 |
| 配置管理 | hardware_config.h/cpp | JSON 配置加载和查询 |

#### 技能层（src/skills/）

| 模块 | 文件 | 主要功能 |
|------|------|---------|
| 技能解析器 | skill_parser.h/cpp | 解析 JSON 技能定义 |
| 技能注册表 | skill_registry.h/cpp | 管理已加载技能 |
| 技能执行器 | skill_executor.h/cpp | 执行技能动作 |
| 机器人技能 | robot/motion_skill.h/cpp | 差速驱动控制 |
| 传感器技能 | robot/sensor_skill.h/cpp | 多传感器数据读取 |

#### LLM 层（src/llm/）

| 模块 | 文件 | 主要功能 |
|------|------|---------|
| LLM 提供者接口 | llm_provider.h | 聊天接口定义 |
| Anthropic 提供者 | anthropic_provider.h/cpp | Claude API 实现 |
| OpenAI 提供者 | openai_provider.h/cpp | GPT API 兼容实现 |
| HTTP 客户端 | http_client.h/cpp | HTTP 请求封装 |

#### 会话层（src/session/）

| 模块 | 文件 | 主要功能 |
|------|------|---------|
| 对话节点 | conversation_node.h/cpp | 单条消息存储 |
| 对话树 | conversation_tree.h/cpp | 树状对话结构 |
| 会话管理器 | session_manager.h/cpp | 会话创建、切换、持久化 |

#### 优化层（src/optimization/）

| 模块 | 文件 | 主要功能 |
|------|------|---------|
| Token 优化器 | token_optimizer.h/cpp | 上下文压缩 |
| 对话压缩器 | conversation_compressor.h/cpp | 消息合并策略 |
| Token 预算 | token_budget.h/cpp | 模型限制管理 |

#### CLI 层（src/cli/）

| 模块 | 文件 | 主要功能 |
|------|------|---------|
| 交互模式 | interactive_mode.h/cpp | REPL 循环，命令解析 |
| 配置向导 | config_wizard.h/cpp | 首次配置引导 |
| 技能命令 | skill_commands.h/cpp | 技能管理 CLI |

#### 基础设施层（src/utils/ & src/storage/）

| 模块 | 文件 | 主要功能 |
|------|------|---------|
| 日志系统 | logger.h/cpp | 分级日志输出 |
| 线程池 | thread_pool.h/cpp | 任务队列管理 |
| 终端 UI | terminal.h/cpp | 彩色输出、进度条 |
| 配置管理 | config_manager.h/cpp | TOML 配置读写 |

---

## 三、目录结构

```
RoboClaw/
├── src/                          # 源代码目录
│   ├── agent/                    # Agent 核心逻辑
│   │   ├── agent.h/cpp           # Agent 主引擎
│   │   ├── tool_executor.h/cpp    # 工具执行器
│   │   └── prompt_builder.h/cpp   # 提示词构建器
│   ├── tools/                    # 工具实现
│   │   ├── read_tool.h/cpp       # 文件读取
│   │   ├── write_tool.h/cpp      # 文件写入
│   │   ├── edit_tool.h/cpp       # 文件编辑
│   │   ├── bash_tool.h/cpp       # 命令执行
│   │   ├── serial_tool.h/cpp     # 串口通信
│   │   ├── browser_tool.h/cpp    # 浏览器控制
│   │   └── agent_tool.h/cpp      # Agent 管理
│   ├── hal/                      # 硬件抽象层
│   │   ├── motor_controller.h    # 电机控制接口
│   │   ├── sensor.h              # 传感器接口
│   │   ├── comm.h                # 通信接口
│   │   ├── hal_exception.h       # 异常定义
│   │   ├── hardware_config.h/cpp # 配置管理
│   │   └── drivers/              # 驱动实现
│   │       └── serial_comm.h/cpp # 串口驱动
│   ├── skills/                   # 技能系统
│   │   ├── skill_parser.h/cpp    # 技能解析
│   │   ├── skill_registry.h/cpp  # 技能注册
│   │   ├── skill_executor.h/cpp  # 技能执行
│   │   └── robot/                # 机器人技能
│   │       ├── motion_skill.h/cpp
│   │       └── sensor_skill.h/cpp
│   ├── llm/                      # 大模型集成
│   │   ├── llm_provider.h        # 提供者接口
│   │   ├── anthropic_provider.h/cpp
│   │   ├── openai_provider.h/cpp
│   │   └── http_client.h/cpp
│   ├── session/                  # 会话管理
│   │   ├── conversation_node.h/cpp
│   │   ├── conversation_tree.h/cpp
│   │   └── session_manager.h/cpp
│   ├── optimization/             # 性能优化
│   │   ├── token_optimizer.h/cpp
│   │   ├── conversation_compressor.h/cpp
│   │   └── token_budget.h/cpp
│   ├── cli/                     # 命令行接口
│   │   ├── interactive_mode.h/cpp
│   │   ├── config_wizard.h/cpp
│   │   └── skill_commands.h/cpp
│   ├── utils/                   # 工具类
│   │   ├── logger.h/cpp
│   │   ├── thread_pool.h/cpp
│   │   └── terminal.h/cpp
│   └── storage/                 # 存储层
│       └── config_manager.h/cpp
├── skills/                       # 技能定义目录
│   ├── builtin/                  # 内置技能
│   └── user/                     # 用户技能
├── configs/                      # 配置文件
│   └── hardware.json.example     # 硬件配置示例
├── tests/                        # 测试目录
│   ├── unit/                     # 单元测试
│   └── integration/              # 集成测试
├── docs/                         # 文档目录
│   └── embedded-quickstart.md    # 嵌入式快速入门
├── build/                        # 构建输出目录
├── .robopartner/                 # 运行时数据（对话历史等）
├── CMakeLists.txt                # CMake 构建配置
├── README.md                     # 项目说明
└── CHANGELOG.md                  # 变更日志
```

---

## 四、使用指南

### 4.1 安装和配置

#### 编译要求

- C++20 编译器（Clang、GCC、MSVC）
- CMake 3.20+
- nlohmann/json 3.11.3+
- cpr 库（HTTP 通信）
- pthread（线程支持）

#### 编译步骤

```bash
# 1. 创建构建目录
mkdir build && cd build

# 2. 配置项目
cmake ..

# 3. 编译
make -j4

# 4. 运行
./robopartner
```

#### 首次配置

首次运行会自动启动配置向导，引导用户完成：
- 选择界面语言（中文/英文）
- 配置 LLM 提供商（Anthropic、OpenAI、DeepSeek 等）
- 输入 API 密钥
- 选择默认模型

配置文件保存在：`~/.robopartner/config.toml`

### 4.2 交互模式使用

启动后进入交互式对话模式：

```
RoboPartner v0.3.0
======================================================

You: 帮我读取 src/main.cpp 文件的前 50 行

Agent: [调用 Read 工具读取文件]
[显示文件内容]

You: 修改第 10 行，将 "Hello" 改为 "World"

Agent: [调用 Edit 工具修改文件]
[完成修改]

You: 编译项目

Agent: [调用 Bash 工具执行编译]
[显示编译结果]
```

### 4.3 命令行使用

```bash
# 查看帮助
robopartner --help

# 创建新对话
robopartner --new

# 列出所有对话
robopartner conversation --list

# 切换到指定对话
robopartner conversation --switch <conversation-id>

# 显示当前配置
robopartner config --show

# 列出已配置的硬件
robopartner hardware --list

# 测试硬件连接
robopartner hardware --test

# 列出可用技能
robopartner skill --list

# 安装新技能
robopartner skill --install <skill-file>

# 发现本地 Agent
robopartner agent --list
```

### 4.4 硬件控制使用（v0.3.0）

#### 硬件配置

创建硬件配置文件 `~/.robopartner/hardware.json`：

```json
{
  "motors": {
    "motor_left": {
      "type": "roboclaw",
      "port": "/dev/ttyUSB0",
      "address": 128,
      "channel": 0,
      "max_speed": 255
    },
    "motor_right": {
      "type": "roboclaw",
      "port": "/dev/ttyUSB0",
      "address": 128,
      "channel": 1,
      "max_speed": 255
    }
  },
  "sensors": {
    "imu": {
      "type": "mpu6050",
      "bus": "i2c",
      "address": 104
    }
  }
}
```

#### 机器人控制

在对话中使用自然语言控制：

```
You: 前进 50% 速度 2 秒

Agent: [调用 MotionSkill]
[电机以 50% 速度前进 2 秒后停止]

You: 左转 90 度

Agent: [调用 MotionSkill]
[执行转向动作]

You: 读取 IMU 数据

Agent: [调用 SensorSkill]
[显示加速度计和陀螺仪数据]
```

### 4.5 技能系统使用

技能是 JSON 格式的功能描述文件，定义了 Agent 可以执行的操作。

#### 技能文件结构

```json
{
  "name": "技能名称",
  "description": "技能描述",
  "version": "1.0.0",
  "actions": [
    {
      "name": "动作名称",
      "description": "动作描述",
      "tools": ["需要使用的工具"],
      "parameters": {
        "参数名": {
          "type": "string|number|boolean|array|object",
          "description": "参数说明",
          "required": true
        }
      }
    }
  ]
}
```

#### 安装和使用技能

```bash
# 安装技能
robopartner skill --install my_skill.json

# 在对话中使用
You: 执行技能 my_skill

Agent: [解析技能，调用相应工具]
[执行结果]
```

### 4.6 浏览器自动化使用

```
You: 打开浏览器并导航到 GitHub

Agent: [启动浏览器，导航到 github.com]

You: 截图

Agent: [捕获当前页面截图]

You: 在搜索框输入 "RoboPartner"

Agent: [定位搜索框，输入文本]

You: 点击搜索按钮

Agent: [使用 CSS 选择器定位并点击元素]
```

### 4.7 多 Provider 配置

支持同时配置多个 LLM 提供商：

```toml
[llm]
default_provider = "anthropic"

[llm.providers.anthropic]
api_key = "sk-ant-..."
base_url = "https://api.anthropic.com"
model = "claude-sonnet-4-20250514"

[llm.providers.openai]
api_key = "sk-..."
base_url = "https://api.openai.com/v1"
model = "gpt-4"
```

---

## 五、开发指南

### 5.1 添加新工具

1. 在 `src/tools/` 创建 `new_tool.h` 和 `new_tool.cpp`
2. 继承自 `ToolBase` 基类
3. 实现 `execute()` 方法
4. 在 `tool_executor.cpp` 中注册新工具
5. 添加单元测试到 `tests/unit/`

### 5.2 添加新技能

1. 创建 JSON 格式技能文件
2. 定义技能动作和参数
3. 将文件放入 `skills/user/` 目录
4. 使用 `skill --install` 安装

### 5.3 扩展硬件支持

1. 在 `src/hal/drivers/` 创建新驱动
2. 实现对应的 HAL 接口（IMotorController、ISensor 或 IComm）
3. 在 `hardware_config.cpp` 中添加配置解析
4. 添加单元测试验证功能

### 5.4 测试

```bash
# 运行所有测试
cd build
ctest --output-on-failure

# 运行特定测试
./tests/unit/test_motor_controller_interface

# 查看测试覆盖
make coverage
```

---

## 六、常见问题

### Q1: 如何切换对话？

使用命令：`robopartner conversation --switch <对话ID>`

### Q2: 如何查看对话历史？

对话历史保存在 `~/.robopartner/conversations/` 目录，以 JSON 格式存储。

### Q3: 如何配置串口设备？

串口配置在硬件配置文件中指定，支持 `/dev/ttyUSB0`、`/dev/ttyACM0` 等路径。

### Q4: 支持哪些 LLM 提供商？

支持：Anthropic (Claude)、OpenAI (GPT)、DeepSeek、Doubao (字节)、Qwen (阿里)。

### Q5: 如何禁用某个工具？

在配置文件中设置 `tools.disabled = ["tool_name"]`

---

## 七、版本历史

- **v0.1.0** - 基础框架，5 个核心工具
- **v0.1.1** - 串口工具
- **v0.2.0** - 浏览器自动化、Agent 管理
- **v0.3.0** - 嵌入式机器人平台、HAL 层、硬件控制

---

## 八、贡献指南

欢迎贡献代码！请参考 `CONTRIBUTING.md` 了解详细信息。

主要贡献方向：
- 新工具实现
- 新 LLM 提供者支持
- 硬件驱动扩展
- 性能优化
- 文档改进
- Bug 修复

---

## 九、许可证

MIT License - 详见 LICENSE 文件
